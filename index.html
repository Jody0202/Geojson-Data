<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Article 4 Map</title>
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBntM7rGCGwI8nN6tzV8snz1te2qLjr8fIH0zYGU5xc6arCbmF1RzO+Ofj/ZaXuoxk5LKOJ5Q7lTg8Jm2Og=="
        crossorigin=""
    />
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
        #searchContainer {
            position: absolute;
            top: 10px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="searchContainer">
        <label for="postcodeInput">Enter postcode:</label>
        <input type="text" id="postcodeInput" />
        <button id="searchButton">Search</button>
    </div>
    <div id="map"></div>

    <script
        src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-MflbTb8vqQYp9XT6aepW5yZ5ehtPOTC/P1ilwTeXyghc2M9BX/BL8h7J+Pe5vD5tGepLbw5ylH11cJ7lV94/kA=="
        crossorigin=""
    ></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        // Initialize the map
        const map = L.map('map').setView([52.5, -1.9], 12);

        // Add the base layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);

        // Define the layer for Article 4 direction area (GeoJSON data)
        let article4Layer;

        // Sample dictionary of codes for Article 4 explanations
        const article4Explanations = {
            "3L": "Restriction on house extension.",
            "5H": "Limitations on changing use of land.",
            "2D": "Conservation area - no demolition of structures."
        };

        // Function to add the Article 4 GeoJSON layer to the map
        function addArticle4Layer(data) {
            article4Layer = L.geoJSON(data, {
                style: function (feature) {
                    return { color: 'blue', weight: 2 };
                }
            }).addTo(map);
        }

        // Fetch the GeoJSON data for Article 4 (using the path that worked in previous code)
        axios.get('your_previous_geojson_path_here')
            .then(response => {
                const article4Data = response.data;
                addArticle4Layer(article4Data);
            })
            .catch(error => {
                console.error('Error loading Article 4 GeoJSON:', error);
            });

        // Function to search by postcode and show Article 4 info
        document.getElementById('searchButton').addEventListener('click', () => {
            const postcode = document.getElementById('postcodeInput').value;

            // Fetch postcode coordinates via Postcodes.io API
            axios
                .get(`https://api.postcodes.io/postcodes/${postcode}`)
                .then(response => {
                    const { longitude, latitude } = response.data.result;

                    // Set the map view to the postcode's location
                    map.setView([latitude, longitude], 14);

                    // Add a marker for the postcode location
                    const marker = L.marker([latitude, longitude]).addTo(map);

                    // Check if the postcode is within any Article 4 area
                    const point = turf.point([longitude, latitude]);
                    let foundArea = null;

                    // Loop through Article 4 GeoJSON features to check if the point is inside a polygon
                    for (const feature of article4Layer.toGeoJSON().features) {
                        const polygon = feature.geometry;
                        if (turf.booleanPointInPolygon(point, polygon)) {
                            foundArea = feature;
                            break;
                        }
                    }

                    // Handle the display of Article 4 info
                    if (foundArea) {
                        // Extract 'permitted-development-rights' field
                        const pdRights = foundArea.properties['permitted-development-rights'] || 'Not specified';

                        // Check if there is an explanation for the code
                        let explanationText = '';
                        if (pdRights !== 'Not specified') {
                            const pdCodes = pdRights.split(',');
                            explanationText = pdCodes
                                .map(code => article4Explanations[code.trim()] || 'Article 4 Direction')
                                .join('<br>');
                        } else {
                            explanationText = 'Article 4 Direction';
                        }

                        // Display a popup with the Article 4 info
                        marker.bindPopup(`Postcode is in an Article 4 area: <br>${explanationText}`).openPopup();
                    } else {
                        marker.bindPopup('Postcode is not in an Article 4 area.').openPopup();
                    }
                })
                .catch(error => {
                    console.error('Error fetching postcode:', error);
                    alert('Invalid postcode or postcode not found.');
                });
        });
    </script>
</body>
</html>
