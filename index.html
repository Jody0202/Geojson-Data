// Initialize map
var map = L.map('map').setView([52.58, -1.83], 12);

// Load the tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

// Define the list of Article 4 codes and their meanings
var article4Codes = {
    '1A': 'Restrictions on Enlargement, improvement or other alteration of a dwellinghouse e.g. Extensions.',
    '1AA': 'Restrictions on Enlargement of a dwellinghouse by construction of additional storeys',
    '1B': 'Restrictions on Additions etc to the roof of a dwellinghouse e.g. Dormers',
    '1C': 'Restrictions on Any other alterations to a roof of a dwellinghouse',
    '1D': 'Restrictions on Porches',
    '1E': 'Restrictions on Buildings etc incidental to the enjoyment of a dwellinghouse e.g. Outbuildings',
    '1F': 'Restrictions on Hard surfaces incidental to the enjoyment of a dwellinghouse',
    '1G': 'Restrictions on Chimneys, flues etc on a dwellinghouse',
    '1H': 'Restrictions on Microwave antenna on a dwellinghouse e.g. Satellite dishes',
    '2A': 'Restrictions on Gates, fences, walls etc',
    '2B': 'Restrictions on Means of access to a highway e.g. driveways',
    '2C': 'Restrictions on Exterior painting',
    '2D': 'Restrictions on Electrical outlet for recharging vehicles',
    '2E': 'Restrictions on Electrical upstand for recharging vehicles',
    '2F': 'Restrictions on Closed circuit television cameras – CCTV',
    '2G': 'Restrictions on Moveable structures for pubs, restaurants etc',
    '3L': 'Restrictions on Small Houses in Multiple Occupation (HMOs) to dwellinghouses and vice versa'
};

// Function to display restrictions based on codes
function getArticle4Restrictions(codes) {
    if (!codes) {
        return "Article 4 Direction";
    }

    let codeList = codes.split('-');
    let restrictions = codeList.map(code => article4Codes[code.trim()] || "Unknown Code");
    return restrictions.join('<br>');
}

// Load the GeoJSON for Article 4 areas
$.getJSON('path/to/your/geojson/file.geojson', function(data) {
  var article4Layer = L.geoJson(data, {
    onEachFeature: function (feature, layer) {
        layer.bindPopup(function (layer) {
            var codes = feature.properties['permitted-development-rights'];
            var restrictions = getArticle4Restrictions(codes);
            return restrictions;
        });
    }
  }).addTo(map);
});

// Function to find postcode and display Article 4 restrictions
function searchPostcode(postcode) {
    // Use a geocoding API to get the location of the postcode
    $.getJSON(`https://nominatim.openstreetmap.org/search?format=json&q=${postcode}`, function(data) {
        if (data.length > 0) {
            var lat = data[0].lat;
            var lon = data[0].lon;
            
            var latLng = L.latLng(lat, lon);
            
            // Set map view to the postcode location
            map.setView(latLng, 16);
            
            // Add a marker at the postcode location
            var marker = L.marker(latLng).addTo(map);
            
            // Check if the postcode falls within any Article 4 areas
            var found = false;
            article4Layer.eachLayer(function(layer) {
                if (layer.getBounds().contains(latLng)) {
                    var codes = layer.feature.properties['permitted-development-rights'];
                    var restrictions = getArticle4Restrictions(codes);
                    marker.bindPopup(restrictions).openPopup();
                    found = true;
                }
            });
            
            if (!found) {
                marker.bindPopup("No Article 4 restrictions at this location.").openPopup();
            }
        } else {
            alert("Postcode not found.");
        }
    });
}

// Add event listener to the postcode search form
document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var postcode = document.getElementById('postcodeInput').value;
    searchPostcode(postcode);
});
