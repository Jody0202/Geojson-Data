<script>
    // Search function for postcode
    async function searchPostcode() {
        const postcode = document.getElementById('postcode').value;
        try {
            const response = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
            const data = await response.json();

            if (data.status === 200) {
                const { latitude, longitude } = data.result;
                mainMap.setView([latitude, longitude], 13);

                const marker = L.marker([latitude, longitude]).addTo(mainMap).bindPopup(`You are here: ${postcode}`);
                marker.openPopup();

                // Check if the postcode falls within an Article 4 polygon
                if (article4Data) {
                    checkInArticle4Area(latitude, longitude, marker);
                }
            } else {
                alert('Postcode not found');
            }
        } catch (error) {
            console.error('Error fetching postcode:', error);
        }
    }

    // Check if a point is inside an Article 4 polygon
    function checkInArticle4Area(lat, lon, marker) {
        const point = turf.point([lon, lat]);
        let foundArea = null;

        // Check if the point is inside any Article 4 polygon
        for (const feature of article4Data.features) {
            const polygon = feature.geometry;
            if (turf.booleanPointInPolygon(point, polygon)) {
                foundArea = feature;
                break; // Exit loop once found
            }
        }

        if (foundArea) {
            const pdRights = foundArea.properties['permitted-development-rights'] || ''; // Extract PDR info
            const notes = foundArea.properties['Notes'] || ''; // Extract Notes info
            const restrictions = getRestrictionsFromCodes(pdRights, notes);
            showRestrictionsInOverlay(restrictions); // Show the restrictions in the overlay
            marker.bindPopup(`You are located in: Article 4 Direction.`).openPopup();
        } else {
            marker.bindPopup(`You are not in an Article 4 area.`).openPopup();
        }
    }

    // Convert the codes in 'permitted-development-rights' into their descriptions, using 'Notes' if necessary
    function getRestrictionsFromCodes(codes, notes) {
        if (!codes || codes.trim() === '' || codes === 'None given') {
            if (notes && notes.trim() !== '') {
                return `<h3>Article 4 Direction</h3><p>${notes}</p>`;
            } else {
                return `<h3>Article 4 Direction</h3><p>No information.</p>`;
            }
        }

        const codeArray = codes.split(';');
        const descriptions = codeArray.map(code => article4CodeMeanings[code] || `Unknown code: ${code}`);
        return `<h3>Article 4 Direction</h3><ul>${descriptions.map(desc => `<li>${desc}</li>`).join('')}</ul>`;
    }

    // Show restrictions in a full-screen overlay
    function showRestrictionsInOverlay(restrictions) {
        const overlay = document.getElementById('popup-overlay');
        const content = document.getElementById('popup-content');
        content.innerHTML = restrictions; // Set the restrictions in the overlay
        overlay.style.display = 'flex'; // Show the overlay
    }

    // Close the popup overlay
    document.getElementById('close-popup').addEventListener('click', () => {
        document.getElementById('popup-overlay').style.display = 'none';
    });
</script>
